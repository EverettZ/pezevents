# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy previews for PRs to main/staging/develop
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop, staging, main]
  # push:
  #   branches:
  #     - 'dev-preview/**'
  #     - 'staging-preview/**'
  #     - 'prod-preview/**'

jobs:

  print_github_context:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: echo "$GITHUB_CONTEXT"

  develop_pr_preview:
    runs-on: ubuntu-latest
    if: github.base_ref == 'develop'
    
    steps:
    # Checkout and setup node
    - uses: actions/checkout@master
    - uses: actions/setup-node@master
      with:
        node-version: '13.x'
    
    # Install dependencies and build
    - name: Build dev
      run: | 
        npm ci
        npm run build

    - name: Deploy dev preview 
      uses: w9jds/firebase-action@v2.0.0
      with:
        args: hosting:channel:deploy -P dev-pezevents --only dev-pezevents  ${{github.run_id}}-${{github.run_number}}
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_CI_TOKEN }}


  staging_pr_preview:
    runs-on: ubuntu-latest
    if: github.base_ref == 'staging'
    
    steps:
    # Checkout and setup node
    - uses: actions/checkout@master
    - uses: actions/setup-node@master
      with:
        node-version: '13.x'
    
    # Install dependencies and build
    - name: Build staging
      run: | 
        npm ci
        npm run build:staging

    - name: Deploy staging preview 
      uses: w9jds/firebase-action@v2.0.0
      with:
        args: hosting:channel:deploy -P stage-pezevents --only stage-pezevents  ${{github.run_id}}-${{github.run_number}}
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_CI_TOKEN }}


  main_pr_preview:
    runs-on: ubuntu-latest
    if: github.base_ref == 'main'
    
    steps:
    # Checkout and setup node
    - uses: actions/checkout@master
    - uses: actions/setup-node@master
      with:
        node-version: '13.x'
    
    # Install dependencies and build
    - name: Build prod
      run: | 
        npm ci
        npm run build:prod

    - name: Deploy prod preview 
      uses: w9jds/firebase-action@v2.0.0
      with:
        args: hosting:channel:deploy -P pezevents --only pezevents  ${{github.run_id}}-${{github.run_number}}
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_CI_TOKEN }}

  print_github_context_after:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context after run
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: echo "$GITHUB_CONTEXT"
  # prod_preview:
  #   runs-on: ubuntu-latest
  #   if: github.ref != 'refs/heads/main'
  #   steps:
  #     - uses: actions/checkout@v2
  #     - run: npm ci && npm run build --prod
  #     - uses: FirebaseExtended/action-hosting-deploy@v0
  #       with:
  #         repoToken: '${{ secrets.GITHUB_TOKEN }}'
  #         firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_PEZEVENTS }}'
  #         projectId: pezevents
  #       env:
  #         FIREBASE_CLI_PREVIEWS: hostingchannels
  # dev_preview:
  #   runs-on: ubuntu-latest
  #   if: github.ref != 'refs/heads/develop'
  #   steps:
  #     - uses: actions/checkout@v2
  #     - run: npm ci && npm run build
  #     - uses: FirebaseExtended/action-hosting-deploy@v0
  #       with:
  #         repoToken: '${{ secrets.GITHUB_TOKEN }}'
  #         firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_DEV_PEZEVENTS }}'
  #         projectId: dev-pezevents
  #         target: dev-pezevents
  #       env:
  #         FIREBASE_CLI_PREVIEWS: hostingchannels
  # stage_preview:
  #   runs-on: ubuntu-latest
  #   if: github.ref != 'refs/heads/staging'
  #   steps:
  #     - uses: actions/checkout@v2
  #     - run: npm ci && npm run build
  #     - uses: FirebaseExtended/action-hosting-deploy@v0
  #       with:
  #         repoToken: '${{ secrets.GITHUB_TOKEN }}'
  #         firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGE_PEZEVENTS }}'
  #         projectId: stage-pezevents
  #         target: stage-pezevents
  #       env:
  #         FIREBASE_CLI_PREVIEWS: hostingchannels